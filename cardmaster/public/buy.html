<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./static/assets/css/main.css" />


    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"
        media="all">


    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
        media="all">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css" rel="stylesheet" media="all">


    <!-- Bootstrap bootstrap-touch-slider Slider Main Style Sheet -->
    <link href="./static/assets/css/bootstrap-touch-slider.css" rel="stylesheet" media="all">
    <title>Buy</title>
</head>

<body class="homepage is-preload">
    <div id="page-wrapper">
        <!-- Nav -->
        <nav id="nav">
            <ul>
                <li><a href="index">Home</a></li>
                <li class="current"><a href="buy">구매</a></li>
                <li><a href="sales">판매</a></li>
                <li><a href="login" id="isLogin">로그인</a></li>
            </ul>
        </nav>

        <div id="ether">
            보유 토큰 : <text id="balanceOfToken"></text>
        </div>

    </div>
</body>

<body> 

      <div class="myContent"></div>
</body>

<body>


    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bignumber.js/bignumber.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
    <script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
    <script src="./static/libs/commonUtil.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyDYu8NfIoLK2iQj-3PTmcYRGmqS5B3f4Uo",
            authDomain: "dbpbl-13bbf.firebaseapp.com",
            databaseURL: "https://dbpbl-13bbf-default-rtdb.firebaseio.com",
            projectId: "dbpbl-13bbf",
            storageBucket: "dbpbl-13bbf.appspot.com",
            messagingSenderId: "379273770681",
            appId: "1:379273770681:web:b25788b8098ffb4a7c8d68",
            measurementId: "G-EN3FK5T60E"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>

    <script>
        const CrowdSaleAddr = "0x13D0F1196BA7D94aC9FD1324a715E559E2e99665";
        const ItemTokenAddr = "0x0ABD2Cb2667fDfaa59e3bad810BFcac40C055983";
        const TokenABI = [
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_to",
                        "type": "address"
                    },
                    {
                        "name": "_value",
                        "type": "uint256"
                    }
                ],
                "name": "transfer",
                "outputs": [
                    {
                        "name": "",
                        "type": "bool"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "_owner",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "name": "balance",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "totalSupply",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            }
        ];
        const CrowdSaleABI = [
            {
                "constant": true,
                "inputs": [],
                "name": "rate",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "weiRaised",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "wallet",
                "outputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "remainingTokens",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "tokenWallet",
                "outputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_beneficiary",
                        "type": "address"
                    }
                ],
                "name": "buyTokens",
                "outputs": [],
                "payable": true,
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "token",
                "outputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "name": "_rate",
                        "type": "uint256"
                    },
                    {
                        "name": "_wallet",
                        "type": "address"
                    },
                    {
                        "name": "_token",
                        "type": "address"
                    },
                    {
                        "name": "_tokenWallet",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "payable": true,
                "stateMutability": "payable",
                "type": "fallback"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "name": "purchaser",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "name": "beneficiary",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "name": "value",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "TokenPurchase",
                "type": "event"
            }
        ];

        let account, GameToken, CrowdSale, GasPrice;

        $(document).ready(() => {
            console.log(window.web3);
            if (typeof window.web3 !== "undefined") {
                web3js = new Web3(window.web3.currentProvider);
                console.log("Connect to Mist/MetaMask");
            } else {
                window.alert("MetaMask 접속이 안되어있습니다!");
                window.location = "./login";
            }

            GameToken = web3js.eth.contract(TokenABI).at(ItemTokenAddr);
            CrowdSale = web3js.eth.contract(CrowdSaleABI).at(CrowdSaleAddr);

            web3js.eth.getAccounts(function (error, result) {
                if (result.length) {
                    console.log(result);
                    account = result[0];
                    $("#account").text(result[0]);

                    balanceOf();
                } else {
                    window.alert("접속된 계정이 없습니다!");
                    window.location = "./login";
                }
            });

            //currencyOptionDraw();
            GasPrice = getGasPrice();
        });


        function getGasPrice() {
            return new Promise((resolve, reject) => {
                $.getJSON('https://ethgasstation.info/json/ethgasAPI.json', (data) => {
                    resolve(data['safeLow'] / 10);
                });
            });
        }

        function balanceOf() {
            web3js.eth.getBalance(account, (error, result) => {
                if (errorChk("getBalance 호출 실패", error)) return;

                var myEther = BigNumber(result);
                if (myEther.isLessThan(1000000000000000))
                    var etherMessage = " (경고 : 이더 부족으로 실행하지 못할 수도 있습니다.)"
                else
                    etherMessage = "";

                $("#balanceOf").text(myEther.toFixed() + " wei" + etherMessage);
            });
            GameToken.balanceOf(account, (error, result) => {
                if (errorChk("Token balanceOf 호출 실패", error)) return;

                $("#balanceOfToken").text(BigNumber(result).toFixed() + "Token");
            });
            GameToken.balanceOf(CrowdSaleAddr, (error, result) => {
                if (errorChk("CrowdSale Token balanceOf 호출 실패", error)) return;

                $("#availableSaleToken").text(BigNumber(result).toFixed() + "Token");
            });

            CrowdSale.rate((error, result) => {
                if (errorChk("CrowdSale Token rate 호출 실패", error)) return;
                console.log(result);
                $("#rate").val(BigNumber(result).toFixed());
            });

            GasPrice.then((data) => { "14.3" });
        }

        var userid, meta;
    
        //판매중인 티켓 리스트 나열 
        //데이터 가져오기

        let res;
        var isTrans = false;

        let isTransfered = async function() {
            //let txId = $('#txID').val();
            //var res = callTransfer();
            if (res) {
                console.log("전달은 된다", res);
                //var res = "0x58b4ef639eb51866d5c04d3d9928347f12340666480ed90b4227c4f59b9e150f"
                //console.log("결과값 전달"+res); 
                //console.log(typeof (txId));
                //아직 tx가 생성되는 중이어서 result에 값이 안들어가는듯?
                //sleep(30000);  //30초 기다림 (이 줄 실행하고 다음 줄 실행하도록 sleep 함수 생성)
                await web3js.eth.getTransactionReceipt(res, function (error, result) {
                    if (!error) {
                        //console.log(JSON.stringify(result));
                        //console.log(result.status);   //상태 출력

                        //status가 0x1이면 uid 변경 코드 추가하기
                        if (result.status == "0x1") {
                            console.log("0x1과 같음");
                            isTrans=true; 
                            //db 수정
                            //changeuid();
                            console.log("결과값2" , isTrans);
                            return isTrans;
                            
                        }
                    }
                    else
                        console.error(error);
                })
            }
            else{
                console.log("기다려주세요")
            }
        }


        function callTransfer(meta, price) {
            //let recipent = $('#recipent').val();

            //let transferValue = BigNumber($("#tokenValue").val());

            /*if (transferValue.isLessThan(0)) {
                alert("0보다 큰값을 입력해 주세요!");
                return;
            }*/

            //transferValue = transferValue.multipliedBy($("#transfer_unit").val());
            //console.log(account);

            //console.log(meta);
            //console.log(transferValue.toFixed());

            GameToken.transfer.sendTransaction(
                meta,
                price,
                {
                    from: account,
                    gasPrice: BigNumber("14.3").multipliedBy(500000000)
                },
                (error, result) => {
                    if (errorChk("transfer(transaction) 실패", error)) return false;
                    console.log("여기", result);
                    res = result;
                    var txURl = "https://goerli.etherscan.io/tx/" + result;
                    /*txLog({
                        targetEl: "result",
                        msg: account + " 에게 " + price + " GT 전송 완료 [<a target=\"_blank\" href=\"" + txURl + "\">" + result + "</a>]"
                    })*/
                }
            );
        }
    </script>
    <script>
        const db = firebase.firestore();
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                $('#isLogin').text('로그아웃');
                userid = user.uid; //사용자 아이디 가져옴
                console.log(userid);
                //로그아웃 클릭 시
                $('#isLogin').click(function () {
                    firebase.auth().signOut().then(function () {
                        alert("로그아웃 되었습니다")
                        //로그인 페이지로 이동시키고 세션 저장시키기
                        window.location.href = "login"
                    }).catch(function (error) {
                        if (error) {
                            alert("로그인 실패");
                        }
                    });
                });
            }
        });
        db.collection('ticket')
            .where('price', '!=', 'null')
            .get()
            .then((result) => {

                result.forEach((doc) => {
                    console.log(doc.data())
                    const userTemplate = `
                    <div style=" float: left; padding:3px;  width: 50%;">
              <div style=" float: left; text-align : center; width: 40%;">
                <img src="./static/images/TicketPoster${doc.data().tName}.jpg" alt="Bootstrap Touch Slider" class="slide-image" height="200" width="150"/>
              </div>
              <div style=" float: left; width: 60%;">
                <p class="user-box__uid">   티켓 번호 : ${doc.data().tNumber}</p>
                <p class="user-box__uid">   공연일자 : ${doc.data().tDate}</p>
                <p class="user-box__uid">   티켓 가격 : ${doc.data().tCost}</p>
                <p class="user-box__uid">   공연명 : ${doc.data().tName}</p>
                <p class="user-box__uid">   예매자명 : ${doc.data().uid}</p>
                <p class="user-box__tCost">   판매 가격 : ${doc.data().price}</p>
                <button type="button" id="sBtn">구매</button>
                <button type="button" id="btnCheck">구매 확정</button>
                <button type="button" onClick="isTransfered();">구매 확정</button>
            </div>
        </div>`;

                    document.querySelector('.myContent').insertAdjacentHTML('afterbegin', userTemplate);
                    //const db = firebase.firestore(); <
                    //<button type="button" onClick="isTransfered();">구매 확정</button>
                    
                    db.collection('ticket')
                    $('#sBtn').click(function () {  //구매 버튼을 클릭한 결과
                        if (userid) {
                            if (confirm('정말로 티켓을 구매하시겠습니까?')) {
                                meta = doc.data().metamask;
                                price = doc.data().price;
                                callTransfer(meta, price);  //돈 보내기
                            }
                            $('#btnCheck').click(function () {
                                console.log("터치됨");
                                if (isTransfered()) { //db 수정
                                    // 티켓DB에서 아이디 변경 (판매자 → 구매자)
                                    //티켓 정보 가져와서 소유자명 변경하기
                                    console.log("true 전달됨")
                                    db.collection('ticket').doc(doc.id).update({
                                        //**로그인된 사람으로 수정하기**
                                        uid: userid,
                                        //price 값 'null'로 변경
                                        price: "null",
                                        metamask: account
                                    }).then(() => {
                                        console.log("Owner changed!!");
                                        meta = doc.id
                                        console.log(meta);
                                        //window.location.href = "buy"
                                    })
                                        .catch((error) => {
                                            // The document probably doesn't exist.
                                            console.error("Error rewritten: ", error);
                                        });
                                }
                                else console.log("먼저 실행됨")
                            })
                        }
                        else {
                            alert("로그인 후 이용 가능합니다.");
                        }
                    });
                });


            });
            /*function changeuid(){
                    document.querySelector('.myContent').insertAdjacentHTML('afterbegin', userTemplate);
                    db.collection('ticket').doc(doc.id).update({
                            //**로그인된 사람으로 수정하기**
                            uid: userid,
                            //price 값 'null'로 변경
                            price: "null",
                            metamask: account
                        }).then(() => {
                            console.log("Owner changed!!");
                            //window.location.href = "buy"
                        })
                            .catch((error) => {
                                // The document probably doesn't exist.
                                console.error("Error rewritten: ", error);
                            });
                }*/

    </script>


</body>

</html>